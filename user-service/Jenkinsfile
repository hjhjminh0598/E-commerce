// Jenkinsfile for E-commerce Monorepo - User Service CI

pipeline {
    agent any // Runs on the Jenkins master VM (which has Docker, gcloud, Java, Maven)

    tools {
        // Ensure these tool names match what you configured in Jenkins Global Tool Configuration
        maven 'MAVEN_HOME' // e.g., MAVEN_HOME, or your chosen name
        jdk 'JDK_17'       // e.g., JDK_17, or your chosen name
    }

    environment {
        // Variables specific to this service's pipeline
        SERVICE_DIR                 = 'user-service'
        IMAGE_NAME                  = 'user-service'
        GCP_PROJECT_ID              = 'fresh-replica-458307-s5'
        GAR_LOCATION                = 'us'
        GAR_REPOSITORY              = 'gcr.io'
        IMAGE_TAG                   = "build-${env.BUILD_NUMBER}-amd64"
        GCP_SA_CREDENTIAL_ID        = 'gcp-sa-artifact-registry' // <<<--- ADD THIS LINE BACK
    }

    stages {
        // ... (Checkout, Build & Test Application stages remain the same) ...

        stage('Build and Push Docker Image') {
            steps {
                dir(env.SERVICE_DIR) { // Ensure your Dockerfile is in this directory
                    script {
                        // Define image details robustly within the script block
                        def serviceName = env.IMAGE_NAME // Should pick up 'user-service' from pipeline env
                        def imageTag = "build-${currentBuild.number}-amd64" // Use currentBuild.number
                        def fullImageName = "${env.GAR_LOCATION}-docker.pkg.dev/${env.GCP_PROJECT_ID}/${env.GAR_REPOSITORY}/${serviceName}:${imageTag}"

                        echo "Building and pushing Docker image: ${fullImageName}"

                        withCredentials([file(credentialsId: env.GCP_SA_CREDENTIAL_ID, variable: 'GCP_KEY_FILE_PATH')]) {
                            sh """
                                echo "Attempting Docker login to https://${env.GAR_LOCATION}-docker.pkg.dev using provided SA key..."
                                cat "${GCP_KEY_FILE_PATH}" | docker login -u _json_key --password-stdin https://${env.GAR_LOCATION}-docker.pkg.dev

                                echo "Login attempt finished. Proceeding with Docker build and push for ${fullImageName}"
                                docker buildx build --platform linux/amd64 -t "${fullImageName}" --push .
                            """
                        }
                        echo "Push process for ${fullImageName} completed."
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
            // Optional: Clean up workspace to save disk space on Jenkins master
            // cleanWs()
        }
        success {
            echo "Pipeline Succeeded: ${env.IMAGE_NAME}:${env.IMAGE_TAG} pushed to GAR."
        }
        failure {
            echo 'Pipeline failed. Check console output for details.'
        }
    }
}